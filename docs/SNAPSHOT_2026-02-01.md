# IdeaCapital System Snapshot (2026-02-01)

> **Status:** v0.5.2 (Alpha Candidate)
> **Theme:** DeSci, Compliance, and Deep Tech Activation

This document provides a comprehensive overview of the IdeaCapital architecture as it stands today. It captures the transition from "Mock MVP" to "Hardened Platform".

---

## 1. System Architecture

IdeaCapital uses an **Event-Driven Microservices** architecture.

```mermaid
graph TD
    User[Flutter App (The Face)] -->|HTTPS| API[TS Backend (The Nervous System)]
    User -->|WalletConnect| Chain[Polygon Blockchain]

    API -->|Pub/Sub: investment.pending| Vault[Rust Financial Engine]
    Vault -->|RPC| Chain
    Chain -->|Event: Investment| Vault

    Vault -->|Pub/Sub: investment.confirmed| API
    API -->|Firestore Write| DB[(Firestore)]
    DB -->|Stream| User

    API -->|Pub/Sub: ai.processing| Brain[Python AI Agent]
    Brain -->|Vertex AI| LLM[Gemini Pro]
    Brain -->|ZKP| Proof[Circom Circuit]
    Brain -->|Firestore Write| DB
```

---

## 2. What We Built (v0.5.x)

### A. The Vault (Rust) — "The Trust Layer"
-   **Merkle Compatibility:** Fixed a critical P0 bug where Rust used SHA256 but Solidity expected Keccak256. Implemented "Double Hash" logic (`keccak(keccak(encode))`).
-   **ABS Compliance:** Implemented fee-sharing logic. Before distributing dividends, the Vault queries `compliance_fee_splits` and deducts Lawyer/Platform fees. **Fail-Closed:** If the DB query fails, distribution aborts.
-   **Reactive Indexing:** Wired up the `investment.pending` -> `ChainWatcher` -> `investment.confirmed` loop.

### B. The Face (Flutter) — "The Experience"
-   **Vib3 Watermark:** Replaced heavy shaders with a performant "Digital Seal".
    -   **Web:** Uses `@vib3code/sdk` (WebGL) via `HtmlElementView`.
    -   **Mobile:** Uses `CustomPainter` geometric approximation (Canvas).
-   **Investment Flow:** Completed `InvestScreen` with WalletConnect integration and a "Mock Mode" for dev testing.
-   **DeSci UI:** Added "Verifiable Novelty" badge triggered by ZK Proofs.

### C. Deep Tech — "The Secret Sauce"
-   **ZKP:** Scaffolded `novelty.circom` circuit and `POST /prove_novelty` API.
-   **Story Protocol:** Created `StoryProtocolAdapter.sol` to register IdeaCapital IP-NFTs on the global IP ledger.

---

## 3. What Is Coming (v0.6.0)

-   **Real ZKP:** Compiling the Circom circuit and generating valid SNARKs using `snarkjs`.
-   **Production Infra:** Deploying the Terraform definitions to GCP.
-   **Marketplace:** Secondary trading of Royalty Tokens.

---

## 4. Key File Manifest

| Path | Purpose |
|------|---------|
| `vault/src/crypto/merkle.rs` | **Critical.** Generates Merkle roots compatible with Solidity. |
| `vault/src/routes/dividends.rs` | **Critical.** Financial logic. Calculates shares and deducts legal fees. |
| `contracts/contracts/IPNFT.sol` | **Core.** The patent asset. Registers with Story Protocol. |
| `contracts/contracts/Governance.sol` | **Gov.** Liquid Democracy voting logic. |
| `frontend/lib/widgets/vib3_watermark.dart` | **UI.** Cross-platform procedural visual identity. |
| `brain/src/zkp/novelty.circom` | **DeSci.** Zero-Knowledge circuit for novelty verification. |
| `infra/terraform/main.tf` | **Ops.** Infrastructure-as-Code definition. |

---

## 5. Dev Commentary

**Why Vib3 Watermark?**
The full-screen background shader looked cool but killed battery and performance on lists. The "Watermark" preserves the unique identity (deterministically generated from the ID) but renders it as a lightweight seal.

**Why tiny-keccak?**
Solidity's `keccak256` is standard. Rust's default `sha2` crate is not. We had to switch to ensure the Merkle Proofs generated off-chain could actually be verified on-chain.

**Why Fail-Closed in Dividends?**
If the database connection drops while calculating fees, we cannot default to "0 fees". That would violate the Arizona ABS legal structure. We must crash/abort the transaction to ensure compliance.
