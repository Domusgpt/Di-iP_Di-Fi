# IdeaCapital Technical Reference Manual

**Version 2.0 â€” March 2026**
**Audience:** Developers, Auditors, System Architects

---

## 1. System Overview

IdeaCapital operates on a **Hybrid Architecture** that leverages the strengths of both centralized and decentralized systems.
-   **Centralized (Efficiency):** AI processing, Social Graph, Financial Calculation (Rust).
-   **Decentralized (Trust):** Ownership (NFTs), Governance (DAO), Revenue Distribution (Smart Contracts).

### 1.1 High-Level Architecture

The system follows an **Event-Driven Architecture** centered around Google Cloud Pub/Sub. The Blockchain is the "Source of Truth" for value, while the Backend is the "Nervous System" for coordination.

```mermaid
graph TD
    User[Flutter App] -->|HTTPS| API[Cloud Functions]
    API -->|Pub/Sub| Brain[The Brain (Python/AI)]
    API -->|Pub/Sub| Vault[The Vault (Rust/Finance)]
    Vault -->|RPC| Chain[Polygon Blockchain]
    Vault -->|SQL| DB[(PostgreSQL)]
    Brain -->|SQL| Fire[(Firestore)]
    Chain -->|Events| Vault
```

---

## 2. Component Deep Dive

### 2.1 The Vault (Financial Engine)

**Role:** The Trust Layer. Handles financial precision, blockchain indexing, and dividend proof generation.
**Language:** Rust (Axum, Tokio, sqlx)

#### Key Implementation Details
*   **Precision:** All financial values are stored and calculated using `rust_decimal::Decimal` (96-bit fixed-point) to prevent floating-point errors.
*   **Merkle Tree Compatibility:** The Merkle Tree implementation (`vault/src/crypto/merkle.rs`) is specifically engineered to match OpenZeppelin's `MerkleProof.sol`.
    *   **Leaf Construction:** `keccak256(keccak256(abi.encode(address, amount)))`
    *   **Sorting:** Pairs are sorted `(min, max)` before hashing to ensure deterministic tree construction.
    *   **Validation:** Verified against test vectors in `contracts/test/MerkleCompatibility.test.ts`.

#### Failure Modes
*   **Fail-Closed:** The dividend distribution logic (`vault/src/routes/dividends.rs`) queries the `compliance_fee_splits` table first. If this query fails or returns an invalid state (e.g., total fees > 100%), the entire transaction aborts. This ensures no funds can be distributed without legal compliance.

### 2.2 The Brain (Verification Engine)

**Role:** The Intelligence Layer. Handles AI analysis and Zero-Knowledge Proofs.
**Language:** Python (FastAPI, Circom, SnarkJS)

#### ZK-Novelty Proofs
*   **Circuit:** `novelty.circom` implements a `ProvenanceProof`.
*   **Hashing:** Uses the **Poseidon** hash function (optimized for ZK circuits) to commit to the invention content.
*   **Constraint:** `publicHash === Poseidon(content[0], content[1], content[2], content[3])`.
*   **Deep Mock Mode:** For local development without `snarkjs` installed, the service falls back to a "Deep Mock" that simulates the constraint checking logic in Python, ensuring the *flow* is tested even if the *crypto* is stubbed.

### 2.3 The Ledger (Smart Contracts)

**Role:** The Ownership Layer. Immutable rules for assets and governance.
**Language:** Solidity 0.8.24 (Hardhat)

#### Contract Suite
1.  **`IPNFT.sol`:** ERC-721 representing the invention.
    *   **Story Protocol Integration:** Automatically registers the IP asset with Story Protocol's global IP index upon minting via `StoryProtocolAdapter`.
2.  **`ReputationToken.sol`:** Soulbound ERC-20.
    *   **Transfer Logic:** Overrides `_update` to revert any transfer where `from != 0` and `to != 0`. This strictly enforces non-transferability.
3.  **`Governance.sol`:** Liquid Democracy.
    *   **Delegation:** Allows `delegate(address)` to shift voting power.
    *   **MVP Limitation:** Current implementation uses `balanceOf(voter)` for voting power. Full delegation chain traversal is scheduled for v2 (Gas optimization required).
4.  **`DividendVault.sol`:** Revenue Distribution.
    *   **Pull vs Push:** Uses a "Pull" pattern (Claim) to minimize gas costs for the protocol. Users provide the Merkle Proof generated by The Vault.

---

## 3. Security Model

### 3.1 Trust Assumptions
*   **The Vault is Trusted:** The Vault has the power to post Merkle Roots. We mitigate this centralization risk via:
    *   **Timelocks:** Governance can replace the Vault's signing key with a 48-hour delay (`Timelock.sol`).
    *   **Audit Logs:** All calculations are written to an immutable append-only `audit_logs` table in PostgreSQL.

### 3.2 Access Control
*   **Smart Contracts:** Uses `Ownable` and `AccessControl`.
    *   `IPNFT` minting is restricted to the `Vault` (or `Timelock`).
    *   `DividendVault` root posting is restricted to the `Vault`.
*   **Cloud Infrastructure:**
    *   **Firestore Rules:** Strict RLS (Row Level Security). Users can only read their own drafts (`request.auth.uid == resource.data.creator_id`). Public inventions are readable by all.
    *   **Service Accounts:** The Brain and Vault run with least-privilege IAM roles (e.g., `pubsub.publisher`, `cloudsql.client`).

---

## 4. Data Flow

### 4.1 Investment Lifecycle
1.  **User Actions:** User signs `approve(USDC)` then `invest(id, amount)`.
2.  **Blockchain Event:** `Invested(user, amount, id)` emitted.
3.  **Vault Watcher:** `chain_watcher.rs` detects event via RPC.
4.  **Confirmation:** Vault waits for 12 blocks (Polygon) for finality.
5.  **Pub/Sub:** Vault publishes `investment.confirmed`.
6.  **Backend:** TypeScript service updates Firestore `investments/{id}` status to `CONFIRMED`.
7.  **Frontend:** UI updates in real-time via Firestore snapshot listener.

### 4.2 Dividend Distribution
1.  **Trigger:** Admin/Lawyer triggers `POST /distribute/{id}` on Vault.
2.  **Calculation:** Vault computes `(Revenue - Fees) / TotalSupply`.
3.  **Merkle Tree:** Vault builds tree and proofs.
4.  **On-Chain:** Vault calls `DividendVault.createDistribution(root, amount)`.
5.  **Notification:** Users notified of claimable dividends.
6.  **Claim:** User calls `claimDividend(epoch, amount, proof)` on-chain.

---

## 5. Development Standards

### 5.1 Code Quality
*   **Rust:** strict clippy linting, `cargo test`.
*   **TypeScript:** ESLint + Prettier, strict type checking (no `any`).
*   **Solidity:** Hardhat tests with `ethers.js`, gas reporting.
*   **Python:** Black formatter, `pytest`.

### 5.2 CI/CD
*   **GitHub Actions:** Runs all test suites on PR.
*   **Docker:** All services containerized. Production images built from `main` branch.

---

## 6. Known Limitations (v0.6.0)

1.  **Governance Delegation:** The `getVotingPower` function does not yet recursively trace delegation chains. It only counts direct balance.
2.  **ZKP Trusted Setup:** The `novelty.circom` circuit requires a trusted setup ceremony which has not yet been performed for Mainnet.
3.  **Oracle Dependency:** The system relies on The Vault as an oracle for off-chain events. Decentralizing this via Chainlink Functions is on the v1.0 roadmap.
